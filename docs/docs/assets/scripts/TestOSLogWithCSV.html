<head>
<title>Test OS Log with CSV Download</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet' href="https://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" type='text/css'>
<script src="https://code.jquery.com/jquery-1.9.1.min.js" type='text/javascript'></script>
<script src="https://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js" type='text/javascript'></script>
</head>
<body>
<style> table, th, td { border: 0px solid black; padding: 0px; border-collapse: collapse; border-right:solid 10px transparent; } .ui-select{width:250px;}</style>
<div data-role='page' id='page_api'>
<div data-role='header'><h3>Test OS Log with CSV Download</h3></div>
<div data-role='content'>
<table>
<tr><td><b>OS IP/OTC: </b></td><td><input type='text' size=16 maxlength=32 id='ip' value='192.168.1.15' oninput=ipchange()></td><td></td></tr>
<tr id='portrow'><td><b>OS port: </b></td><td><input type='text' size=4 maxlength=5 id='port' value='80'></td><td></td></tr>
<tr><td><b>Password: </b></td><td><input type='password' size=12 maxlength=32 id='key' value='opendoor'></td><td></td></tr>
<tr id='tr_hist'><td><b>History: </b></td><td><select name='sel_hist' id='sel_hist' onChange='select_hist()'>
  <option value=0>Today</option>
  <option value=1>Since 1 day ago</option>
  <option value=2>Since 2 days ago</option>
  <option value=3>Since 3 days ago</option>
  <option value=4>Since 4 days ago</option>
  <option value=5>Since 5 days ago</option>
  <option value=6>Since 6 days ago</option>
  <option value='sel'>Select date range</option>
  </select></td><td></td></tr>
<tr id='tr_start' class='tr_reset tr_sel'><td><b>Start Date: </b></td><td><input type="date" data-clear-btn="false" name="date-1" id="date-1" value=""></td><td></td></tr>
<tr id='tr_end' class='tr_reset tr_sel'><td><b>End Date: </b></td><td><input type="date" data-clear-btn="false" name="date-2" id="date-2" value=""></td><td></td></tr>
<tr><td><b>Log type: </b></td><td><select name='sel_lgtype' id='sel_lgtype'>
  <option value=' '>Standard</option>
  <option value='wl'>Water level (wl)</option>
  <option value='fl'>Flow sensor (fl)</option>
  <option value='rd'>Rain delay (rd)</option>
  <option value='s1'>Sensor 1 (s1)</option>
  <option value='s2'>Sensor 2 (s2)</option>
  </select></td><td></td></tr>
</table>

<div data-role="controlgroup" data-type="horizontal">
  <a href='#' data-role='button' data-theme='a' id='btn_clear'>Clear Cache</a> 
  <a href='#' data-role='button' data-theme='b' id='btn_submit'>Submit</a> 
</div>
<p><b>HTTP command: <label class='msg_reset' id='comm_msg'></label></b></p>
<textarea readonly class='msg_reset' id='command'></textarea>
<p><b>Raw Response: <label class='msg_reset' id='validity'></label></b>
<textarea readonly style='height:180px;' class='msg_reset' id='response'></textarea>
</p>
<script>
let api = 'jl';
let hist = 0;
let command = '';
let store_name = 'oslog_params';
let download = true;
let date = new Date();
let year = date.getFullYear();
let month = pad(date.getMonth() + 1);
let day = pad(date.getDate());
$('#date-1').val(year + '-' + month + '-' + day);
$('#date-2').val(year + '-' + month + '-' + day);

function clear_text() {
  $('.msg_reset').text('').css('color', 'black');
}
function compose_command() {
  let ip = $('#ip').val();
  let port = $('#port').val();
  if(isNaN(port)) port=80;
  let key = $('#key').val();
  let sel_hist = $('#sel_hist option:selected').val();
  let sel_lgtype = $('#sel_lgtype option:selected').val();
  if(ip.startsWith("https")) {
    command = ip+'/'+api+'?pw='+md5(key);
  } else if(ip.startsWith("http")) {
    command = ip+':'+port+'/'+api+'?pw='+md5(key);
  } else if(ip.startsWith("OT") && ip.length === 32) {
    command = 'https://cloud.openthings.io/forward/v1/'+ip+'/'+api+'?pw='+md5(key);;
  } else {
    command = 'http://'+ip+':'+port+'/'+api+'?pw='+md5(key);
  }

  if(sel_hist === 'sel'){
    let start = new Date ($('#date-1').val()+"T00:00");
    let end = new Date ($('#date-2').val()+"T00:00");
    command+='&start='+(start/1000>>0)+'&end='+(end/1000>>0)+'&type='+sel_lgtype;
  }else{
    command+='&hist='+sel_hist+'&type='+sel_lgtype;
  }
  
  let store = {
    _ip: ip,
    _port: port,
    _key: key,
    _sel_hist: sel_hist,
    _sel_lgtype: sel_lgtype,
  };
  localStorage.setItem(store_name, JSON.stringify(store));
  return true;
}
function select_hist(){
  hist = $('#sel_hist option:selected').val();
  $('.tr_reset').hide();
  $('.tr_'+hist).show();
  $('msg_reset').css('color', 'gray');
}
$('#btn_submit').click(function(e){
  e.preventDefault();
  clear_text();
  if(compose_command()==false) return;
  $('#command').text(command);
  $('#validity').text('(waiting for response...)').css('color','#aaa');
  $('#comm_msg').text('sent at '+(new Date()).toLocaleString()).css('color', 'green');
  $.ajax({
    url: command,
    dataType: 'text',
    error: function(){$('#validity').text('ERROR! IP/port not reacheable or timeout happened!').css('color','maroon');},
    success: function(result){
      $('#response').text(result);
      if(isValidJson(result)) {
        if(download){
          let csv = convertToCSV(JSON.parse(result));
          downloadLog(csv);
          download = false;
        }
        $('#validity').text('is valid JSON').css('color','green');
      } else {
        $('#validity').text('ERROR! INVALID JSON!').css('color','red');
      }
    },
    timeout: 5000
  });
});
$('#btn_clear').click(function(e){
  e.preventDefault();
  if(!confirm('Are you sure to clear local storage?')) return;
  localStorage.removeItem(store_name);
  window.location.reload();
});
$(document).ready(function() {
  $('.tr_reset').hide();
  let store = localStorage.getItem(store_name);
  if(store) {
    let obj = JSON.parse(store);
    if(obj._ip) $('#ip').val(obj._ip);
    if(obj._port) $('#port').val(obj._port);
    if(obj._key) $('#key').val(obj._key);
    if(obj._sel_hist) $('#sel_hist').val(obj._sel_hist).selectmenu('refresh');
    if(obj._sel_lgtype) $('#sel_lgtype').val(obj._sel_lgtype).selectmenu('refresh');
  }
  ipchange();
  select_hist();
});
function ipchange() {
  let ip = $('#ip').val();
  if(ip.startsWith('https') || ip.startsWith('OT')) {
    $('#portrow').hide();
  } else{
    $('#portrow').show();
  }
}
function isValidJson(text) {
  try {
    let o = JSON.parse(text);
    if(o && typeof o==='object') {return o;}
  } catch(e) {return null;}
  return null;
}

function downloadLog(log){
  const blob = new Blob([log], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'log.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function convertToCSV(obj){
  //Get zone names for log output
  let names;
  let temp = api;
  api = 'jn';
  compose_command();
  $.ajax({
    url: command,
    dataType: 'text',
    async: false,
    error: function(){console.log('jn call encountered an error.')},
    success: function(result){
      if(isValidJson(result)) {
        let obj = JSON.parse(result);
        names = obj.snames;
      } else {
        console.log('jn call returned invalid JSON.')
      }
    },
    timeout: 5000
  });
  api = temp;

  let csv = [];
  let data = {
    Start: null,
    End: null,
    Duration: null,
    Program: null,
    Station: null,
    Flow: null
  }

  csv.push(Object.keys(data).join(','));
  for(let i = 0; i < obj.length; i++){
    data.Program = parseInt(obj[i][0]);
    if(data.Program !== 0){
      data.Station = names[parseInt(obj[i][1])];
    }else{
      data.Station = obj[i][1];
    }
    let start = new Date( parseInt( obj[i][3] * 1000 ) - ( obj[i][2] * 1000 ) );
    data.Start = start.getUTCMonth() + '/' + start.getUTCDate() + '/' + start.getUTCFullYear() + ' ' + pad(start.getUTCHours()) + ':' + pad(start.getUTCMinutes()) + ':' + pad(start.getUTCSeconds());
   
    let end = new Date(parseInt(obj[i][3] * 1000));
    data.End = end.getUTCMonth() + '/' + end.getUTCDate() + '/' + end.getUTCFullYear() + ' ' + pad(end.getUTCHours()) + ':' + pad(end.getUTCMinutes()) + ':' + pad(end.getUTCSeconds());
    
    data.Duration = parseInt(obj[i][2]);

    if(obj[i].length === 5){data.Flow = parseFloat(obj[i][4])}else{data.Flow = null};
    
    csv.push(Object.values(data).join(','));
  }
  return csv.join('\n');
}

function pad( number ) {
	var r = String( number );
	if ( r.length === 1 ) {
		r = "0" + r;
	}
	return r;
}

// Define MD5 library (see libs.js for attribution)
!function(a){"use strict";function b(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function c(a,b){return a<<b|a>>>32-b}function d(a,d,e,f,g,h){return b(c(b(b(d,a),b(f,h)),g),e)}function e(a,b,c,e,f,g,h){return d(b&c|~b&e,a,b,f,g,h)}function f(a,b,c,e,f,g,h){return d(b&e|c&~e,a,b,f,g,h)}function g(a,b,c,e,f,g,h){return d(b^c^e,a,b,f,g,h)}function h(a,b,c,e,f,g,h){return d(c^(b|~e),a,b,f,g,h)}function i(a,c){a[c>>5]|=128<<c%32,a[(c+64>>>9<<4)+14]=c;var d,i,j,k,l,m=1732584193,n=-271733879,o=-1732584194,p=271733878;for(d=0;d<a.length;d+=16)i=m,j=n,k=o,l=p,m=e(m,n,o,p,a[d],7,-680876936),p=e(p,m,n,o,a[d+1],12,-389564586),o=e(o,p,m,n,a[d+2],17,606105819),n=e(n,o,p,m,a[d+3],22,-1044525330),m=e(m,n,o,p,a[d+4],7,-176418897),p=e(p,m,n,o,a[d+5],12,1200080426),o=e(o,p,m,n,a[d+6],17,-1473231341),n=e(n,o,p,m,a[d+7],22,-45705983),m=e(m,n,o,p,a[d+8],7,1770035416),p=e(p,m,n,o,a[d+9],12,-1958414417),o=e(o,p,m,n,a[d+10],17,-42063),n=e(n,o,p,m,a[d+11],22,-1990404162),m=e(m,n,o,p,a[d+12],7,1804603682),p=e(p,m,n,o,a[d+13],12,-40341101),o=e(o,p,m,n,a[d+14],17,-1502002290),n=e(n,o,p,m,a[d+15],22,1236535329),m=f(m,n,o,p,a[d+1],5,-165796510),p=f(p,m,n,o,a[d+6],9,-1069501632),o=f(o,p,m,n,a[d+11],14,643717713),n=f(n,o,p,m,a[d],20,-373897302),m=f(m,n,o,p,a[d+5],5,-701558691),p=f(p,m,n,o,a[d+10],9,38016083),o=f(o,p,m,n,a[d+15],14,-660478335),n=f(n,o,p,m,a[d+4],20,-405537848),m=f(m,n,o,p,a[d+9],5,568446438),p=f(p,m,n,o,a[d+14],9,-1019803690),o=f(o,p,m,n,a[d+3],14,-187363961),n=f(n,o,p,m,a[d+8],20,1163531501),m=f(m,n,o,p,a[d+13],5,-1444681467),p=f(p,m,n,o,a[d+2],9,-51403784),o=f(o,p,m,n,a[d+7],14,1735328473),n=f(n,o,p,m,a[d+12],20,-1926607734),m=g(m,n,o,p,a[d+5],4,-378558),p=g(p,m,n,o,a[d+8],11,-2022574463),o=g(o,p,m,n,a[d+11],16,1839030562),n=g(n,o,p,m,a[d+14],23,-35309556),m=g(m,n,o,p,a[d+1],4,-1530992060),p=g(p,m,n,o,a[d+4],11,1272893353),o=g(o,p,m,n,a[d+7],16,-155497632),n=g(n,o,p,m,a[d+10],23,-1094730640),m=g(m,n,o,p,a[d+13],4,681279174),p=g(p,m,n,o,a[d],11,-358537222),o=g(o,p,m,n,a[d+3],16,-722521979),n=g(n,o,p,m,a[d+6],23,76029189),m=g(m,n,o,p,a[d+9],4,-640364487),p=g(p,m,n,o,a[d+12],11,-421815835),o=g(o,p,m,n,a[d+15],16,530742520),n=g(n,o,p,m,a[d+2],23,-995338651),m=h(m,n,o,p,a[d],6,-198630844),p=h(p,m,n,o,a[d+7],10,1126891415),o=h(o,p,m,n,a[d+14],15,-1416354905),n=h(n,o,p,m,a[d+5],21,-57434055),m=h(m,n,o,p,a[d+12],6,1700485571),p=h(p,m,n,o,a[d+3],10,-1894986606),o=h(o,p,m,n,a[d+10],15,-1051523),n=h(n,o,p,m,a[d+1],21,-2054922799),m=h(m,n,o,p,a[d+8],6,1873313359),p=h(p,m,n,o,a[d+15],10,-30611744),o=h(o,p,m,n,a[d+6],15,-1560198380),n=h(n,o,p,m,a[d+13],21,1309151649),m=h(m,n,o,p,a[d+4],6,-145523070),p=h(p,m,n,o,a[d+11],10,-1120210379),o=h(o,p,m,n,a[d+2],15,718787259),n=h(n,o,p,m,a[d+9],21,-343485551),m=b(m,i),n=b(n,j),o=b(o,k),p=b(p,l);return[m,n,o,p]}function j(a){var b,c="";for(b=0;b<32*a.length;b+=8)c+=String.fromCharCode(a[b>>5]>>>b%32&255);return c}function k(a){var b,c=[];for(c[(a.length>>2)-1]=void 0,b=0;b<c.length;b+=1)c[b]=0;for(b=0;b<8*a.length;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<b%32;return c}function l(a){return j(i(k(a),8*a.length))}function m(a,b){var c,d,e=k(a),f=[],g=[];for(f[15]=g[15]=void 0,e.length>16&&(e=i(e,8*a.length)),c=0;16>c;c+=1)f[c]=909522486^e[c],g[c]=1549556828^e[c];return d=i(f.concat(k(b)),512+8*b.length),j(i(g.concat(d),640))}function n(a){var b,c,d="0123456789abcdef",e="";for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),e+=d.charAt(b>>>4&15)+d.charAt(15&b);return e}function o(a){return unescape(encodeURIComponent(a))}function p(a){return l(o(a))}function q(a){return n(p(a))}function r(a,b){return m(o(a),o(b))}function s(a,b){return n(r(a,b))}function t(a,b,c){return b?c?r(b,a):s(b,a):c?p(a):q(a)}"function"==typeof define&&define.amd?define(function(){return t}):a.md5=t}(this);
</script>
</div><!--content-->
</div><!--page-->
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"fd31c820bc3048c5ae4c253709e3f2bf","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>

